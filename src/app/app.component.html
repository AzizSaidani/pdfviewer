<div class="app-container">
  <header class="header">
    <!-- Main Controls -->
    <nav class="controls" aria-label="Main actions" *ngIf="!pdfSaved">
      <button (click)="addSignature()" class="btn btn-secondary" [disabled]="!pdfLoaded || !currentSignature"
        title="Add Signature" aria-label="Add Signature">âœï¸</button>
      <button (click)="addInitial()" class="btn btn-secondary" [disabled]="!pdfLoaded || !currentInitial"
        title="Add Initial" aria-label="Add Initial">ğŸ”¤</button>
      <button (click)="savePDF()" class="btn btn-success" [disabled]="!pdfLoaded || signatures.length === 0"
        title="Save PDF" aria-label="Save PDF">ğŸ’¾</button>
      <button (click)="clearSignatures()" class="btn btn-warning" [disabled]="signatures.length === 0"
        title="Clear All Signatures" aria-label="Clear All">ğŸ—‘ï¸</button>
    </nav>

    <!-- View-Only Mode Header -->
    <div class="view-only-header" *ngIf="pdfSaved">
      <div class="success-badge">âœ“ Document Signed</div>
    </div>

    <!-- Page Navigation Controls -->
    <div class="page-controls" *ngIf="pdfLoaded">
      <button (click)="goToPreviousPage()" class="btn btn-nav" [disabled]="currentPageNumber === 1"
        title="Previous Page" aria-label="Previous Page">â¬…ï¸</button>
      <span class="page-info">Page {{ currentPageNumber }} / {{ totalPages }}</span>
      <button (click)="goToNextPage()" class="btn btn-nav" [disabled]="currentPageNumber === totalPages"
        title="Next Page" aria-label="Next Page">â¡ï¸</button>
    </div>
  </header>

  <!-- Loading and Error Messages -->
  <section class="main-content" *ngIf="!pdfLoaded">
    <div class="upload-area">
      <!-- General Error -->
      <div class="error-message" *ngIf="errors.general">
        <h3>âš ï¸ Error</h3>
        <p>{{ errors.general }}</p>
      </div>

      <!-- PDF Loading -->
      <div class="loading-message" *ngIf="loading.pdf">
        <div class="spinner"></div>
        <p>Loading PDF...</p>
      </div>

      <!-- PDF Error -->
      <div class="error-message" *ngIf="errors.pdf">
        <h3>âš ï¸ PDF Load Error</h3>
        <p>{{ errors.pdf }}</p>
      </div>

      <!-- Waiting for PDF -->
      <div class="upload-message" *ngIf="!loading.pdf && !errors.pdf && !errors.general">
        <h2>PDF Viewer</h2>
        <p>Initializing...</p>
        <div class="upload-icons">ğŸ“„ âœï¸</div>
      </div>
    </div>
  </section>

  <!-- Enhanced PDF Viewer with Flutter WebView Compatibility -->
  <section class="main-content" *ngIf="pdfLoaded && currentPageData">
    <div class="pdf-viewer" #pdfViewer>
      <div class="page-container">
        <div class="page-header">
          <span>Page {{ currentPageNumber }} / {{ totalPages }}</span>
          <span *ngIf="getSignaturesForCurrentPage().length > 0" class="signature-count">
            {{ getSignaturesForCurrentPage().length }} âœï¸
          </span>
        </div>

        <div class="page-canvas-container" [style.width.px]="currentPageData.width"
          [style.height.px]="currentPageData.height"
          style="touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;">

          <!-- Enhanced canvas with mobile quality improvements -->
          <canvas [width]="currentPageData.width" [height]="currentPageData.height"
            style="touch-action: none; pointer-events: none;"></canvas>

          <!-- Flutter WebView optimized signatures -->
          <ng-container *ngFor="let sig of getSignaturesForCurrentPage()">
            <div class="placed-signature" [style.left.px]="sig.x" [style.top.px]="sig.y" [style.width.px]="sig.width"
              [style.height.px]="sig.height" [class.view-only]="pdfSaved"
              style="touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;"
              (pointerdown)="!pdfSaved && startDrag(sig, $event)" (touchstart)="!pdfSaved && startDrag(sig, $event)"
              (mousedown)="!pdfSaved && startDrag(sig, $event)">

              <img [src]="sig.imageData" alt="Signature" class="signature-image"
                style="pointer-events: none; touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;"
                draggable="false">

              <button class="delete-signature" (click)="removeSignature(sig.id)" *ngIf="!pdfSaved"
                (pointerdown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()"
                (mousedown)="$event.stopPropagation()" title="Delete Signature" aria-label="Delete Signature"
                style="touch-action: manipulation;">Ã—</button>

              <div class="resize-handles" *ngIf="!pdfSaved">
                <div class="resize-handle resize-se"
                  style="touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;"
                  (pointerdown)="startResize(sig, $event)" (touchstart)="startResize(sig, $event)"
                  (mousedown)="startResize(sig, $event)">
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </section>

  <!-- Saving Loading Overlay -->
  <div class="saving-overlay" *ngIf="loading.saving">
    <div class="saving-content">
      <div class="spinner large"></div>
      <h2>Saving PDF...</h2>
      <p>Please wait while we upload your signed document</p>
    </div>
  </div>

  <!-- Error Toast -->
  <div class="error-toast" *ngIf="errors.general && pdfLoaded">
    <p>{{ errors.general }}</p>
  </div>

  <!-- Success Screen -->
  <div class="success-overlay" *ngIf="showSuccessMessage">
    <div class="success-content">
      <div class="success-icon">âœ“</div>
      <h2>Success!</h2>
      <p>Your document has been signed and saved</p>
    </div>
  </div>
</div>